{{- range (append .Values.nodeClasses ((merge (dict "name" "control-plane") .Values.controlPlane))) }}
---
# If apiversion changes please also change in name field below
apiVersion: infrastructure.cluster.x-k8s.io/v1alpha5
kind: OpenStackMachineTemplate
metadata:
  #Â we should not delete existing templates during upgrades
  # since capi needs old templates to be able to rollout machines.
  finalizers:
  - cluster-api-cleaner-openstack.finalizers.giantswarm.io
  labels:
    {{- include "labels.common" $ | nindent 4 }}
  # api version upgrades need to change the name below to create a new resource  
  # since OpenStackMachineTemplate are immutable
  name: {{ include "resource.default.name" $ }}-{{ .name }}-{{ include "osmtRevision" (merge . $) }}-v1alpha5
  namespace: {{ $.Release.Namespace }}
spec:
  template:
    spec:
      cloudName: {{ $.Values.cloudName | quote }}
      flavor: {{ .flavor | quote }}
      identityRef:
        name: {{ $.Values.cloudConfig }}
        kind: Secret
      {{- if not $.Values.nodeCIDR }}
      networks:
      - filter:
          name: {{ $.Values.networkName }}
        subnets:
        - filter:
            name: {{ $.Values.subnetName }}
      {{- end }}
      {{- if .bootFromVolume }}
      rootVolume:
        diskSize: {{ .diskSize }}
      {{- end }}
      image: {{ .image | quote }}
{{- end }}
